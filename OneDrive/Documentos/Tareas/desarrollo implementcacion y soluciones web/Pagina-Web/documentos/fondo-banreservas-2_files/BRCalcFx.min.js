function setMask(element, prefix) {
    $(element).inputmask({
        rightAlign: !1,
        prefix: prefix + " ",
    })
}

function setPercentajeMask(element) {
    $(element).inputmask({
        rightAlign: !1,
        alias: "percentage",
        digits: 2,
    })
}
function mostrarError(mensaje) {
    jQuery(".estadoSolicitud").html(`<p class="orange-font">${mensaje}</p>`);
    setTimeout(function () {
        jQuery(".estadoSolicitud").html("");
    }, 4500);
}

function getPeriodText(cantidad, tipo) {
    if (tipo === "Anio") {
        if (cantidad == 1)
            return cantidad + " año";
        if (cantidad > 1)
            return cantidad + " años"
    }
    if (tipo === "Mes") {
        if (cantidad == 1)
            return cantidad + " mes";
        if (cantidad > 1)
            return cantidad + " meses"
    }
}
$(document).ready(function () {
    var type = window?.calculator?.type;

    if (type != null) {
        jQuery('[data-toggle="tooltip"]').tooltip();
        var monedas = {
            DOP: "RD$",
            USD: "US$",
            EUR: "€",
        };
        var moneyFormat = Intl.NumberFormat("en-US");
        if (type == 1) {
            setMask("input", "US$ ");
            $(".calculadoras section[id!='divisas']").remove();
            $('#divisas').addClass('active');
            $("input[id*='USD']").click(function () {
                $("#lblCompraEU").hide();
                $("#lblVentaEU").hide();
                $("#lblCompraUS").show();
                $("#lblVentaUS").show();
                CalcularCompra("US$");
                CalcularVenta("US$")
            });
            $("input[id*='EUR']").click(function () {
                $("#lblCompraUS").hide();
                $("#lblVentaUS").hide();
                $("#lblCompraEU").show();
                $("#lblVentaEU").show();
                CalcularCompra("€");
                CalcularVenta("€")
            });

            function CalcularCompra(moneda) {
                var idLabel = $("label[for='" + "txtCompraMonto" + "'] :visible").attr("id");
                var compra = $("#" + idLabel).text();
                $("#txtCompraResultado").val("");
                var valMonto = $("#txtCompraMonto").val();
                var compraMonto = parseFloat(valMonto.replace(/[^0-9\.-]+/g, ""));
                $("#txtCompraMonto").inputmask("remove");
                $("#txtCompraMonto").attr("placeholder", moneda + " 0.00");
                setMask($("#txtCompraMonto"), moneda);
                if ($("#txtCompraMonto").val() != "" && compra > 0) {
                    $("#txtCompraResultado").val((compraMonto * compra).toFixed(2))
                }
            }

            function CalcularVenta(moneda) {
                var idLabel = $("label[for='" + "txtVentaMonto" + "'] :visible").attr("id");
                var venta = $("#" + idLabel).text();
                $("#txtVentaResultado").val("");
                var vMonto = $("#txtVentaMonto").val();
                var ventaMonto = parseFloat(vMonto.replace(/[^0-9\.-]+/g, ""));
                $("#txtVentaMonto").inputmask("remove");
                $("#txtVentaMonto").attr("placeholder", moneda + " 0.00");
                setMask($("#txtVentaMonto"), moneda);
                if ($("#txtVentaMonto").val() != "" && venta > 0) {

                    $("#txtVentaResultado").val((ventaMonto * venta).toFixed(2))

                }
            }
            $(document).on("change", "#txtCompraMonto", function () {
                if ($("#USD").is(":checked")) CalcularCompra(monedas.USD);
                else CalcularCompra(monedas.EUR)
            });
            $(document).on("change", "#txtVentaMonto", function () {
                if ($("#USD").is(":checked")) CalcularVenta(monedas.USD);
                else CalcularVenta(monedas.EUR)
            });
            $(document).on("click", "#btnCalcular", function () {
                if ($("#USD").is(":checked")) CalcularCompra(monedas.USD);
                else CalcularVenta(monedas.EUR)
            })
        }
        if (type == 3) {
            $("#Ahorro_DOP").prop('checked', !0);
            $(".calculadoras section[id!='cuentaAhorro']").remove();
            setPercentajeMask($("#tasaInteres"));
            $('#cuentadeahorro, #intereses').addClass('active');
            setMask("input", "RD$ ");
            $(document).on("click", ".plazoInversion", function () {
                $("#tipoPlazo").val($(this).attr("tipoPlazo"))
            });
            $(document).on("click", ".tipoMoneda", function () {
                var moneda = $(this).attr("tipoMoneda");
                var formatoMoneda = $(this).val();
                $("#tipoMoneda").val($(this).attr("tipoMoneda"));
                $("#montoInicial").inputmask("remove");
                $("#ahorroMensual").inputmask("remove");
                setMask($("#ahorroMensual"), monedas[moneda]);
                setMask($("#montoInicial"), monedas[moneda]);
                $("#montoInicial").attr("placeholder", formatoMoneda + " 0.00");
                $("#ahorroMensual").attr("placeholder", formatoMoneda + " 0.00")
            });
            $(document).on("click", "#btnCalcularAhorro", function () {
                var periodo = $("#cantidadPeriodos").val();
                var tipoplazo = $("input[name='plazo']:checked").attr('tipoplazo');
                if (tipoplazo == 1) periodo = periodo * 12;
                var miInit = $("#montoInicial").val();
                var montoInicial = parseFloat(miInit.replace(/[^0-9\.-]+/g, ""));
                var ahMensual = $("#ahorroMensual").val();
                var ahorroMensual = parseFloat(ahMensual.replace(/[^0-9\.-]+/g, ""));
                var moneda = $("#tipoMoneda").val();
                var tasaVal = $("#tasaInteres").val();
                var tasa = parseFloat(tasaVal.replace(/[^0-9\.-]+/g, ""));
                setMask($("#montoInicial"), monedas[moneda]);
                setMask($("#ahorroMensual"), monedas[moneda]);
                setPercentajeMask($("#tasaInteres"));

                if (periodo == 0) {
                    mostrarError("Debe especificar el plazo de inversión.");

                } else {
                    $.ajax({
                        url: '/umbraco/surface/Calculator/GetIntereses',
                        type: "GET",
                        data: {
                            montoInversion: montoInicial,
                            ahorroMensual: ahorroMensual,
                            periodo: periodo,
                            tasa: tasa,
                            moneda: moneda,
                            esCapitalizable: !0,
                        }
                    }).done(function (resultado) {

                        jQuery(".estadoSolicitud").html(`
                        <div class="row">
                          <div class="form-table col-md-12">
	                        <table class="table table-striped table-borderless">
 		                        <thead>
 			                        <tr>
 			                         <th>
 			                         Resultado
 			                         </th>
 			                         <th>
 			                         </th> 
 			                        </tr>
 		                        </thead>
		                        <tbody>
 			                        <tr>
 			                         <td><b>Monto Final</b></td>
 			                         <td><b>${$("[name='moneda']:checked").val() + " " + moneyFormat.format(resultado.montoFinal)}</b></td> 
 			                         </tr>
 			                        <tr>
 			                         <td>Plazo</td>
 			                         <td>${getPeriodText($("#cantidadPeriodos").val(), $("[name='plazo']:checked").attr("formato"))}</td> 
 			                        </tr>
 			                        <tr class="odd">
 			                         <td>Interés</td>
 			                         <td>7 % Interés total al plazo establecido</td> 
 			                        </tr>
	                        </tbody>
                          </table>
                         </div>
                        </div>
                    `)
                    }).fail(function (jqXHR, textStatus, errorThrown) {

                        mostrarError("Ocurrió un error al realizar el cálculo.");

                    });
                }

                

            })
        }
        if (type == 4) {
            $(".calculadoras section[id!='certificadoFinanciero']").remove();
            setMask($("#montoInicial"), monedas.DOP);
            setPercentajeMask($("#tasaInteres"));
            $('#certificadofinanciero, #intereses').addClass('active');
            $(document).on("click", ".tipoMoneda", function () {
                var moneda = $(this).attr("tipoMoneda");
                var formatoMoneda = $(this).val();
                $("#montoInicial").inputmask("remove");
                setMask($("#montoInicial"), monedas[moneda]);
                $("#montoInicial").attr("placeholder", formatoMoneda + " 0.00");
                $("#tipoMoneda").val($(this).attr("tipoMoneda"))
            });
            $(document).on("click", ".reInvertir", function () {
                $("#reInvertir").val($(this).attr("data-value"))
            });
            $(document).on("click", "#btnCalcularCertificadoFinanciero", function () {
                var montoI = $("#montoInicial").val();
                var montoInicial = parseFloat(montoI.replace(/[^0-9\.-]+/g, ""));
                var periodo = $("#cantidadPeriodos").val();
                var moneda = $("#tipoMoneda").val();
                var tasa = $("#tasaInteres").val();
                tasa = parseFloat(tasa.replace(/[^0-9\.-]+/g, ""))
                var esCapitalizable = $(".btn-group-toggle .btn.active .reInvertir").data("value");


                $.ajax({
                    url: '/umbraco/surface/Calculator/GetCertificado',
                    type: "GET",
                    data: {
                        montoInversion: montoInicial,
                        periodo: periodo,
                        tasa: tasa,
                        moneda: moneda,
                        esCapitalizable: esCapitalizable,
                    }
                }).done(function (resultado) {

                    jQuery(".estadoSolicitud").html(`  
                        <div class="row">
                          <div class="form-table col-md-12">
	                        <table class="table table-striped table-borderless resultados">
 		                        <thead>
 			                        <tr>
 			                         <th>Plazo</th>
 			                         <th>Interés</th>
 			                         <th>Total</th>
 			                        </tr>
 		                        </thead>
		                        <tbody>
	                        </tbody>
                          </table>
                         </div>
                        </div>
                    `);
                    if (esCapitalizable === true)
                    {
                        $.each(resultado.capitalInteres, function (index, item) {
                            $(".resultados tbody").append(`
                              <tr>
                              <td> ${item.periodo + (item.periodo == 1 ? " mes" : " meses")} </td>
                              <td> ${moneyFormat.format(item.interes.toFixed(2))} </td>
                              <td> ${$("[name='moneda']:checked").val() + " " + moneyFormat.format(item.capital.toFixed(2))} </td>
                              </tr>
                            `)
                        })
                    } else
                    {
                        $(".resultados tbody").append(`
			                <tr>
			                <td> ${periodo + (periodo == 1 ? " mes" : " meses")} </td>
			                <td> ${moneyFormat.format(resultado.totalInteres.toFixed(2))} </td>
			                <td> ${$("[name='moneda']:checked").val() + " " + moneyFormat.format((resultado.montoFinal + resultado.totalInteres).toFixed(2))} </td>
			                </tr>
			            `)
                    }
                }).fail(function (jqXHR, textStatus, errorThrown) {

                    mostrarError("Ocurrió un error al realizar el cálculo.");

                });
            })
        }
        if (type == 5) {
            $(".calculadoras section[id!='prestamoHipotecario']").remove();
            setMask($("#costoInmueble"), monedas.DOP);
            setMask($("#montoSolicitado"), monedas.DOP);
            setMask($("#ingresosMensuales"), monedas.DOP);
            setMask($("#egresosMensuales"), monedas.DOP);
            setPercentajeMask($("#tasaFinanciamiento"));
            $('#hipotecarios, #prestamos').addClass('active');
            var moneda = "DOP";
            $(document).on("click", ".tipoMoneda", function () {
                moneda = $(this).attr("tipoMoneda");
                $("#costoInmueble").inputmask("remove");
                setMask($("#costoInmueble"), monedas[moneda]);
                $("#costoInmueble").attr("placeholder", monedas[moneda] + " 0.00");
                $("#montoSolicitado").inputmask("remove");
                setMask($("#montoSolicitado"), monedas[moneda]);
                $("#montoSolicitado").attr("placeholder", monedas[moneda] + " 0.00")
                $("#ingresosMensuales").inputmask("remove");
                setMask($("#ingresosMensuales"), monedas[moneda]);
                $("#ingresosMensuales").attr("placeholder", monedas[moneda] + " 0.00")
                $("#egresosMensuales").inputmask("remove");
                setMask($("#egresosMensuales"), monedas[moneda]);
                $("#egresosMensuales").attr("placeholder", monedas[moneda] + " 0.00")
                $("#tipoMoneda").val($(this).val())
            });
            $(document).on("click", ".cantidadDeudores", function () {
                $("#cantidadDeudores").val($(this).attr("deudores"))
            });
            $(document).on("click", "#btnCalcularHipotecario", function () {
                var vCost = $("#costoInmueble").val();
                var vivienda = parseFloat(vCost.replace(/[^0-9\.-]+/g, ""));
                var mSol = $("#montoSolicitado").val();
                var monto = parseFloat(mSol.replace(/[^0-9\.-]+/g, ""));
                var ingN = $("#ingresosMensuales").val();
                var ingresos = parseFloat(ingN.replace(/[^0-9\.-]+/g, ""));
                var egM = $("#egresosMensuales").val();
                var egresos = parseFloat(egM.replace(/[^0-9\.-]+/g, ""));
                var edad = jQuery("#edad").val();
                var periodo = jQuery("#periodoPrestamo").val() * 12;
                var tasa = jQuery("#tasaFinanciamiento").val().replace("%", "");
                setMask($("#costoInmueble"), monedas[moneda]);
                setMask($("#montoSolicitado"), monedas[moneda]);
                setMask($("#ingresosMensuales"), monedas[moneda]);
                setMask($("#egresosMensuales"), monedas[moneda]);

                if (edad == 0) {
                    mostrarError("La edad especificada es inválida, verifique e intente nuevamente.");

                } else if (periodo == 0) {
                    mostrarError("El período introducido es inválido, verifique e intente nuevamente.");

                } else if (tasa == 0) {
                    mostrarError("La tasa introducida es inválida, verifique e intente nuevamente.");

                }
                    else {
                    $.ajax({
                        url: '/umbraco/surface/Calculator/GetHipotecario',
                        type: "GET",
                        data: {
                            moneda: jQuery("#tipoMoneda").val(),
                            deudores: jQuery("#cantidadDeudores").val(),
                            edad: edad,
                            vivienda: vivienda,
                            monto: monto,
                            periodo: periodo,
                            tasa: tasa,
                            ingresos: ingresos,
                            egresos: egresos,
                        }
                    }).done(function (resultado) {

                        var totalMensualidad = resultado.cuotaMensual + resultado.seguroPropiedad + resultado.seguroVida;

                        jQuery(".estadoSolicitud").html(`
          
                        <div class="row">
                          <div class="form-table col-md-12">
	                        <table class="table table-striped table-borderless">
 		                        <thead>
 			                        <tr>
 			                         <th>
 			                         Resultado
 			                         </th>
 			                         <th>
 			                         </th> 
 			                        </tr>
 		                        </thead>
		                        <tbody>
 			                        <tr>
 			                         <td>Cuota Mensual</td>
 			                         <td>${monedas[moneda] + " " + moneyFormat.format(resultado.cuotaMensual.toFixed(2))}</td> 
 			                         </tr>
 			                        <tr>
 			                         <td>Seguro de Vida</td>
 			                         <td>${monedas[moneda] + " " + moneyFormat.format(resultado.seguroVida.toFixed(2))}</td> 
 			                        </tr>
 			                        <tr>
 			                         <td>Seguro de Propiedad</td>
 			                         <td>${monedas[moneda] + " " + moneyFormat.format(resultado.seguroPropiedad.toFixed(2))}</td> 
 			                        </tr>
 			                        <tr>
 			                         <td>Mensualidad a Pagar</td>
 			                         <td>${monedas[moneda] + " " + moneyFormat.format(totalMensualidad.toFixed(2))}</td> 
 			                        </tr>

	                        </tbody>
                          </table>
                         </div>
                        </div>
                        <p class="alert-Info"> ${resultado.notas} </p>
                    `)

                    }).fail(function (jqXHR, textStatus, errorThrown) {

                        mostrarError("Ocurrió un error al realizar el cálculo.");

                    });
                }

            })
        }
        if (type == 6) {
            $(".calculadoras section[id!='prestamoPersonal']").remove();
            setMask($("#monto"), monedas.DOP);
            setPercentajeMask($("#tasaInteres"));
            $('#personales, #prestamos').addClass('active');
            $(document).on("click", "#btnCalcularPersonal", function () {
                var mPrest = $("#monto").val();
                var monto = parseFloat(mPrest.replace(/[^0-9\.-]+/g, ""));
                var periodo = jQuery("#periodo").val();
                var tasa = jQuery("#tasaInteres").val().replace("%", "");
                setMask($("#monto"), monedas.DOP);

                if (periodo == 0) {
                    mostrarError("El período introducido es inválido, verifique e intente nuevamente.");

                } else if (tasa == 0) {
                    mostrarError("La tasa introducida es inválida, verifique e intente nuevamente.");

                } else {
                    $.ajax({
                        url: '/umbraco/surface/Calculator/GetPersonal',
                        type: "GET",
                        data: {
                            monto: monto,
                            periodo: periodo,
                            tasa: tasa,
                        }
                    }).done(function (resultado) {

                        jQuery(".estadoSolicitud").html(`      
                        <div class="row">
                          <div class="form-table col-md-12">
	                        <table class="table table-striped table-borderless">
 		                        <thead>
 			                        <tr>
 			                         <th>
 			                         Resultado
 			                         </th>
 			                         <th>
 			                         </th> 
 			                        </tr>
 		                        </thead>
		                        <tbody>
 			                        <tr>
 			                         <td><b>Cuota Mensual</b></td>
 			                         <td><b>${"RD$ " + moneyFormat.format(resultado.cuotaMensual)}</b></td> 
 			                        </tr>
 		                        </tbody>
                          </table>
                         </div>
                        </div>
                    `)

                    }).fail(function (jqXHR, textStatus, errorThrown) {

                        mostrarError("Ocurrió un error al realizar el cálculo.");

                    });
                }


                
            })
        }

        if (type == 7) {
            $(".calculadoras section[id!='prestamoVehiculo']").remove();
            setMask($("#valorVehiculo"), monedas.DOP);
            setMask($("#montoInicial"), monedas.DOP);
            setMask($("#monto"), monedas.DOP);
            $('#paravehiculos, #prestamos').addClass('active');
            setPercentajeMask($("#tasaInteres"));
            var valorVehiculo;
            var montoInicial;

            var insuranceLink = window.calculator.insuranceLink;
            var insuranceName = window.calculator.insuranceName;

            $(document).on("change", "#valorVehiculo, #montoInicial", function () {
                $("#monto").val("");
                var mVeh = $("#valorVehiculo").val();
                valorVehiculo = parseFloat(mVeh.replace(/[^0-9\.-]+/g, ""));
                var mInic = $("#montoInicial").val();
                montoInicial = parseFloat(mInic.replace(/[^0-9\.-]+/g, ""));
                setMask($("#valorVehiculo"), monedas.DOP);
                setMask($("#montoInicial"), monedas.DOP);
                if (isNaN(valorVehiculo) || isNaN(montoInicial)) return;
                var monto = valorVehiculo - montoInicial;
                $("#monto").val(monto)
            });
            $(document).on("click", "#btnCalcularVehiculo", function () {
                setMask($("#valorVehiculo"), monedas.DOP);
                setMask($("#montoInicial"), monedas.DOP);
                var periodo = jQuery("#periodo").val();
                var tasa = jQuery("#tasaInteres").val().replace("%", "");
                
                if (periodo == 0) {
                    mostrarError("El período introducido es inválido, verifique e intente nuevamente.");

                } else if (tasa == 0) {
                    mostrarError("La tasa introducida es inválida, verifique e intente nuevamente.");

                } else {

                    $.ajax({
                        url: '/umbraco/surface/Calculator/GetVehiculo',
                        type: "GET",
                        data: {
                            monto: valorVehiculo - montoInicial,
                            periodo: periodo,
                            tasa: tasa,
                        }
                    }).done(function (resultado) {

                        jQuery(".estadoSolicitud").html(`      
                        <div class="row">
                          <div class="form-table col-md-12">
	                        <table class="table table-striped table-borderless">
 		                        <thead>
 			                        <tr>
 			                         <th>
 			                         Resultado
 			                         </th>
 			                         <th>
 			                         </th> 
 			                        </tr>
 		                        </thead>
		                        <tbody>
 			                        <tr>
 			                         <td><b>Cuota Mensual</b></td>
 			                         <td><b>${"RD$ " + moneyFormat.format(resultado.cuotaMensual)}</b></td> 
 			                        </tr>
 		                        </tbody>
                          </table>
                         </div>
                        </div>
                        <div class="row">
  	                        <div class="col-md-12">
  		                        <a href="${insuranceLink}" class="calc-seguros-reservas"  style="font-family:freight_sansbold,sans-serif;font-size:18px;color:#00aef0;" target="_blank">${insuranceName}</a>
	                        </div>
                        </div>
                    `)

                    }).fail(function (jqXHR, textStatus, errorThrown) {

                        mostrarError("Ocurrió un error al realizar el cálculo.");

                    });
                }
            })
        }
    }
    
   
}) 